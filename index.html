<!doctype html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <title>hello-wasm example</title>
    </head>
    <body>
        <script type="module">
            import * as fflate from "https://cdn.skypack.dev/fflate@0.8.2?min";
            import init, { convert } from "./pkg/embolden.js";

            function reader(file, callback) {
                const fr = new FileReader();
                fr.onload = () => callback(null, fr.result);
                fr.onerror = (err) => callback(err);
                // fr.readAsText(file);
                fr.readAsArrayBuffer(file);
            }

            document
                .querySelector("#fileUpload")
                .addEventListener("change", (evt) => {
                    // No files, do nothing.
                    if (!evt.target.files) {
                        return;
                    }
                    let filename = "EMBOLDED_" + evt.target.files[0].name;
                    reader(evt.target.files[0], (err, res) => {
                        // unzipFile(res.split(",", 2)[1].trim());
                        let url = unzipFile(res);
                        openDownload(url, filename);
                    });
                });

            const epubTextExt = new Set(["xhtml", "html", "htm"]); //One file was htm idk why
            const incompressibleExt = new Set([
                "zip",
                "gz",
                "png",
                "jpg",
                "jpeg",
                "pdf",
                "doc",
                "docx",
                "ppt",
                "pptx",
                "xls",
                "xlsx",
                "heic",
                "heif",
                "7z",
                "bz2",
                "rar",
                "gif",
                "webp",
                "webm",
                "mp4",
                "mov",
                "mp3",
                "aifc",
                // Add whatever extensions you don't want to compress
            ]);
            function unzipFile(file) {
                const compressed = new Uint8Array(file);
                const zipper = new fflate.Zip();
                let finalZip = [];
                zipper.ondata = (err, data, final) => {
                    if (err) throw new Error(`failed while zipping ${err}`);

                    finalZip.push(data);

                    if (final) {
                        finalZip = new Blob(finalZip, {
                            type: "application/epub",
                        });
                    }
                };
                // decompress, convert and compress
                const data = fflate.unzip(compressed, (err, res) => {
                    init().then(() => {
                        for (const [key, value] of Object.entries(res)) {
                            const ext =
                                key.slice(key.lastIndexOf(".") + 1) || "";
                            // const ext2 = key.split(".")[-1];
                            const filename = incompressibleExt.has(ext)
                                ? new fflate.ZipPassThrough(key)
                                : new fflate.ZipDeflate(key, { level: 9 });
                            zipper.add(filename);

                            if (epubTextExt.has(ext)) {
                                // skip all files that arent text
                                // then send to rust for converting
                                let bold_raw = convert(value);
                                filename.push(bold_raw);
                            } else {
                                filename.push(value);
                            }
                            filename.push(new Uint8Array(0), true);
                        }
                        zipper.end();

                        let url = URL.createObjectURL(finalZip);
                        console.log(url);
                        return url;
                    });
                });
            }
            function openDownload(url, name) {
                var link = document.createElement("a");
                link.download = name;
                link.href = url;
                link.innerHTML = "Download";
                document.body.appendChild(link);
            }
        </script>
        <input type="file" id="fileUpload" />
    </body>
</html>
